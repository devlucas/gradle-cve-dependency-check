package com.danielsomerfield.cvecheck

import com.danielsomerfield.cvecheck.gradle.GradleProjectScanner
import com.danielsomerfield.cvecheck.gradle.ScanTask
import com.danielsomerfield.cvecheck.owaspdependencycheck.FilePathOutputStreamFactory
import com.danielsomerfield.cvecheck.owaspdependencycheck.OWASPGradleProjectScanner
import com.danielsomerfield.cvecheck.owaspdependencycheck.OWASPScanResult
import com.danielsomerfield.cvecheck.owaspdependencycheck.OWASPScanResultCreator
import com.danielsomerfield.cvecheck.owaspdependencycheck.OutputStreamFactory
import com.danielsomerfield.cvecheck.owaspdependencycheck.ScanResultCreator
import com.danielsomerfield.cvecheck.owaspdependencycheck.reporting.OWASPScanReportGenerator
import com.danielsomerfield.cvecheck.reporting.ScanReportGenerator
import org.gradle.api.Project
import org.owasp.dependencycheck.Engine
import org.owasp.dependencycheck.data.nvdcve.CveDB
import org.owasp.dependencycheck.reporting.ReportGenerator
import org.owasp.dependencycheck.utils.Settings

class GradleTaskConfigurator {

  //TODO: get rid of this dependency--it doesn't make sense because it should be transient
  private Project project;

  def GradleTaskConfigurator(Project project) {
    this.project = project;
  }

  def ScanTask scanTask() {
    new ScanTask(scanner())
  }

  private ScanReportGenerator scanReportGenerator() {
    return new OWASPScanReportGenerator(owaspReportGenerator(), ReportGenerator.Format.VULN, outputStreamFactory())
  }

  def OutputStreamFactory outputStreamFactory() {
    return new FilePathOutputStreamFactory("${project.getBuildDir()}/reports/vulnerabilities.html")
  }

  private ReportGenerator owaspReportGenerator() {
    def engine = engine()
    new ReportGenerator("vulnerability scan", engine.dependencies, engine.analyzers, cveDB().databaseProperties)
  }

  private CveDB cveDB() {
    new CveDB()
  }

  private GradleProjectScanner scanner() {
    new OWASPGradleProjectScanner(scanReportGenerator(), scanResultCreator())
  }

  private ScanResultCreator<OWASPScanResult> scanResultCreator() {
    return new OWASPScanResultCreator(engine())
  }

  private Engine engine() {
    Settings.initialize()
    new Engine()
  }
}
