package com.danielsomerfield.cvecheck.owaspdependencycheck.reporting

import com.danielsomerfield.cvecheck.owaspdependencycheck.OWASPScanResult
import com.danielsomerfield.cvecheck.reporting.ScanReportGenerator
import com.danielsomerfield.util.io.OutputStreamFactory
import org.owasp.dependencycheck.Engine
import org.owasp.dependencycheck.data.nvdcve.CveDB
import org.owasp.dependencycheck.reporting.ReportGenerator
import org.owasp.dependencycheck.reporting.ReportGenerator.Format

class OWASPScanReportGenerator implements ScanReportGenerator<OWASPScanResult> {

  private final Format format;
  private final OutputStreamFactory outputStreamFactory;
  private final CveDB cveDB;

  def OWASPScanReportGenerator(
      Format format,
      OutputStreamFactory outputStreamFactory,
      CveDB cveDB
  ) {
    this.format = format;
    this.outputStreamFactory = outputStreamFactory;
    this.cveDB = cveDB;
  }

  @Override
  def generateReport(OWASPScanResult result) {

    outputStreamFactory.getOutputStream().withCloseable { OutputStream out ->
      Engine engine = result.getEngine()
      new ReportGenerator("vulnerability scan", engine.dependencies, engine.analyzers, cveDB.databaseProperties).generateReports(out, format)
    }
  }
}
