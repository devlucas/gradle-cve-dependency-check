package org.owasp.dependencycheck.gradle

import org.apache.commons.io.FileUtils
import org.apache.commons.io.IOUtils
import org.junit.Test

import java.nio.file.Files

import static org.hamcrest.CoreMatchers.containsString
import static org.hamcrest.CoreMatchers.not
import static org.hamcrest.core.Is.is
import static org.junit.Assert.assertThat

class DependencyCheckGradlePluginE2ETest {

    @Test
    public void testVulnerabilityFoundInGradleProject(){
        def srcFile = new File(new URL(getClass().getResource("/test-project").toExternalForm()).toURI())
        def tempDirFile = Files.createTempDirectory("test-project").toFile()
        FileUtils.copyDirectory(srcFile, tempDirFile)
        new File(tempDirFile, "gradlew").setExecutable(true, true)

        def process = new ProcessBuilder("./gradlew", "test").directory(tempDirFile).start()
        def out = new ByteArrayOutputStream();
        IOUtils.copy(process.getErrorStream(), out)
        assertThat(process.waitFor(), is(not(0)))
        def errorOutput = new String(out.toByteArray(), "UTF-8")
        assertThat(errorOutput, containsString("CVE-2014-1904"))
    }
}
