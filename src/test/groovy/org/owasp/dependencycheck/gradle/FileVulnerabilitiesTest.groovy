package org.owasp.dependencycheck.gradle

import org.junit.Before
import org.junit.Test
import org.owasp.dependencycheck.Engine
import org.owasp.dependencycheck.dependency.Dependency
import org.owasp.dependencycheck.dependency.Vulnerability
import org.owasp.dependencycheck.utils.Settings

import static java.util.UUID.randomUUID
import static org.hamcrest.CoreMatchers.is
import static org.junit.Assert.assertThat

class FileVulnerabilitiesTest {

  private Engine engine
  private List<File> files

  @Before
  def void setup(){
    Settings.initialize()
    files = [new File("file1"), new File("file2")]
    engine = [
        getDependencies : {
          [
              createDependency([createVulnerability(), createVulnerability()], files[0]),
              createDependency([createVulnerability(), createVulnerability(), createVulnerability()], files[1])
          ]
        }
    ] as Engine
  }

  static def Vulnerability createVulnerability() {
    def vulnerability = new Vulnerability()
    vulnerability.setName(randomUUID().toString())
    vulnerability
  }

  def static Dependency createDependency(List<Vulnerability> vulnerabilities, File file) {
    Dependency dependency = new Dependency(file)
    dependency.setVulnerabilities(new TreeSet<Vulnerability>(vulnerabilities))
    dependency;
  }

  @Test
  public void testGetVulnerabilitiesForFiles() {
    Collection<Vulnerability> vulnerabilities = FileVulnerabilities.getVulnerabilitiesForFiles(engine, files);
    assertThat(vulnerabilities.size(), is(5));
  }
}
