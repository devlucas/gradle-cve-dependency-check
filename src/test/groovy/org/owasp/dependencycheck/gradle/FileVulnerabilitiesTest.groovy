package org.owasp.dependencycheck.gradle

import org.junit.Before
import org.junit.Test
import org.owasp.dependencycheck.Engine
import org.owasp.dependencycheck.dependency.Dependency
import org.owasp.dependencycheck.dependency.Vulnerability
import org.owasp.dependencycheck.utils.Settings

import static java.util.UUID.randomUUID
import static org.hamcrest.CoreMatchers.is
import static org.junit.Assert.assertThat

class FileVulnerabilitiesTest {

  private Engine engine
  private List<File> files
  private List<Dependency> dependencies

  @Before
  def void setup(){
    dependencies = []

    Settings.initialize()
    files = [new File("file1"), new File("file2")]
    engine = [
        getDependencies : {
          dependencies
        },
        scan: {File f -> dependencies.add(new Dependency(f)); dependencies},
        analyzeDependencies: {
          dependencies.each { Dependency dependency ->
            setVulnsForDep(dependency)
          }
        }
    ] as Engine
  }

  static def void setVulnsForDep(Dependency dependency) {
    String name = dependency.getActualFile().getName()
    dependency.setVulnerabilities(new TreeSet<Vulnerability>([
        createVulnerability(name + ".1"),
        createVulnerability(name + ".2")
    ]))
  }

  static def Vulnerability createVulnerability(String name) {
    def vulnerability = new Vulnerability()
    vulnerability.setName(name)
    vulnerability
  }

  @Test
  public void testGetVulnerabilitiesForFiles() {
    Collection<Vulnerability> vulnerabilities = FileVulnerabilities.getVulnerabilitiesForFiles(engine, files);
    assertThat(vulnerabilities.size(), is(4));

  }
}
