package com.danielsomerfield.cvecheck.owaspdependencycheck

import com.danielsomerfield.cvecheck.reporting.ScanReportGenerator
import groovy.mock.interceptor.MockFor
import org.junit.Test

import static com.danielsomerfield.cvecheck.TestScaffold.createTypeSafeMock
import static com.danielsomerfield.cvecheck.TestScaffold.mockProject
import static org.hamcrest.CoreMatchers.is
import static org.junit.Assert.assertThat

class OWASPGradleProjectScannerTest {

  @Test
  def void testBasicScan() {
    OWASPScanResult result = createTypeSafeMock(OWASPScanResult){}

    MockFor scanReportGeneratorMock = new MockFor(ScanReportGenerator)
    scanReportGeneratorMock.demand.generateReport { OWASPScanResult r -> assertThat(r, is(result)) }
    ScanReportGenerator<OWASPScanResult> scanReportGenerator =
        scanReportGeneratorMock.proxyDelegateInstance() as ScanReportGenerator<OWASPScanResult>

    ScanResultCreator<OWASPScanResult> scanResultCreator = createTypeSafeMock(ScanResultCreator){
      it.demand.createScanResult {result}
    }

    OWASPGradleProjectScanner scanner = new OWASPGradleProjectScanner(scanReportGenerator, scanResultCreator)
    scanner.scan(mockProject())
    scanReportGeneratorMock.verify(scanReportGenerator)
  }
}
