package com.danielsomerfield.cvecheck.owaspdependencycheck

import com.danielsomerfield.cvecheck.ScanResult
import com.danielsomerfield.cvecheck.ScanningEngineSourceUpdate
import com.danielsomerfield.cvecheck.reporting.ScanReportGenerator
import groovy.mock.interceptor.MockFor
import org.junit.Test

import static com.danielsomerfield.cvecheck.TestScaffold.*
import static org.hamcrest.CoreMatchers.is
import static org.hamcrest.CoreMatchers.notNullValue
import static org.junit.Assert.assertThat

class OWASPGradleProjectScannerIntTest {

  private ScanningEngineSourceUpdate scanningEngineSourceUpdate = createTypeSafeMock(ScanningEngineSourceUpdate) {
    it.demand.run(UNBOUNDED) {}
  }


  @Test
  public void testBasicScan() {
    ScanResult result = new OWASPGradleProjectScanner(
        mockScanReportGenerator(),
        new OWASPScanningEngine(mockEngine(CREATE_TWO_VULNS_PER_DEPENDENCY)),
        scanningEngineSourceUpdate
    ).scan(mockProject())
    assertThat(result.vulnCount, is(2))
  }

  def ScanReportGenerator mockScanReportGenerator() {
    def mock = new MockFor(ScanReportGenerator)
    mock.demand.generateReport { ScanResult rslt -> }
    mock.proxyDelegateInstance() as ScanReportGenerator
  }

  @Test
  public void testBasicScanWithNoVulns() {
    ScanResult result = new OWASPGradleProjectScanner(
        mockScanReportGenerator(),
        new OWASPScanningEngine(mockEngine()),
        scanningEngineSourceUpdate
    ).scan(mockProject())
    assertThat(result.vulnCount, is(0))
  }

  @Test
  public void testBasicScanGeneratesReport() {
    def scanReportGeneratorMock = new MockFor(ScanReportGenerator)
    //TODO: way better assertions
    scanReportGeneratorMock.demand.generateReport { rslt -> assertThat(rslt, is(notNullValue())) }
    def scanReportGenerator = scanReportGeneratorMock.proxyDelegateInstance() as ScanReportGenerator
    new OWASPGradleProjectScanner(
        scanReportGenerator,
        new OWASPScanningEngine(mockEngine()),
        scanningEngineSourceUpdate
    ).scan(mockProject())
    scanReportGeneratorMock.verify(scanReportGenerator)
  }


}
