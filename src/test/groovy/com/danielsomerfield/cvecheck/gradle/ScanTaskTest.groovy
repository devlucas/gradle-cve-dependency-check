package com.danielsomerfield.cvecheck.gradle

import com.danielsomerfield.cvecheck.ScanResult
import com.danielsomerfield.cvecheck.gradle.GradleProjectScanner
import com.danielsomerfield.cvecheck.gradle.ScanTask
import org.gradle.api.GradleException
import org.gradle.api.Project
import org.gradle.api.logging.Logger
import org.junit.Test

import static org.junit.Assert.fail

class ScanTaskTest {

  def project = [
      getLogger: {
        [
            info: {}
        ] as Logger
      }
  ] as Project

  @Test
  public void testScanWithVulnerabilities() {
    GradleProjectScanner scanner = mockScannerWithVulnCount(2)

    try {
      new ScanTask(scanner).scan(project)
      fail("Should have thrown exception indicating failure.")
    } catch (GradleException ignored) {
    }
  }

  @Test
  public void testScanWithNoVulnerabilitiesShouldNotThrow() {
    GradleProjectScanner scanner = mockScannerWithVulnCount(0)
    new ScanTask(scanner).scan(project)
  }

  def GradleProjectScanner mockScannerWithVulnCount(final int vulnCount) {
    def scanResult = [
        getVulnCount: { vulnCount }
    ] as ScanResult

    def scanner = [
        scan: { p -> if (p == project) scanResult }
    ] as GradleProjectScanner
    scanner
  }
}
