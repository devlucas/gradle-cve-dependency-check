package com.danielsomerfield.cvecheck.gradle

import com.danielsomerfield.cvecheck.ScanResult
import com.danielsomerfield.cvecheck.reporting.ScanReportGenerator
import groovy.mock.interceptor.MockFor
import org.gradle.api.GradleException
import org.gradle.api.Project
import org.gradle.api.logging.Logger
import org.junit.Test

import static com.danielsomerfield.cvecheck.TestScaffold.createTypeSafeMock
import static java.lang.Integer.MAX_VALUE

class ScanTaskTest {

  private Project project;
  private ScanReportGenerator scanReportGenerator;

  def ScanTaskTest() {

    project = createTypeSafeMock(Project) {
      it.demand.getLogger {
        createTypeSafeMock(Logger) {
          it.demand.info {}
        }
      }
    }

    scanReportGenerator = new MockFor(ScanReportGenerator).proxyDelegateInstance() as ScanReportGenerator
  }

  def withMockScanner(int vulnCount, Closure test) {
    def scannerMock = new MockFor(GradleProjectScanner)
    scannerMock.demand.scan { p ->
      if (p == project) createTypeSafeMock(ScanResult) {
        it.demand.getVulnCount(MAX_VALUE) { vulnCount }
      }
    }
    test(scannerMock.proxyDelegateInstance(), scannerMock)
  }

  @Test(expected = GradleException)
  public void testScanWithVulnerabilitiesGeneratesReports() {
    withMockScanner(2){ GradleProjectScanner scanner, mock ->
      new ScanTask(scanner).scan(project);
    }
  }

  @Test(expected = GradleException)
  public void testScanWithVulnerabilities() {
    withMockScanner(2){ GradleProjectScanner scanner, mock ->
      new ScanTask(scanner).scan(project);
    }
  }

  @Test
  public void testScanWithNoVulnerabilitiesShouldNotThrow() {
    withMockScanner(0){ GradleProjectScanner scanner, mock ->
      new ScanTask(scanner).scan(project);
    }
  }

  def GradleProjectScanner mockScannerWithVulnCount(final int vulnCount) {
    createTypeSafeMock(GradleProjectScanner) {
      it.demand.scan { p ->
        if (p == project) createTypeSafeMock(ScanResult) {
          it.demand.getVulnCount(MAX_VALUE) { vulnCount }
        }
      }
    }
  }

}
